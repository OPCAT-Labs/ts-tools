'use strict';

var should = require('chai').should();

var opcat = require('../../..');
var Transaction = opcat.Transaction;
var PrivateKey = opcat.PrivateKey;
var Script = opcat.Script;
var MultiSigInput = opcat.Transaction.Input.MultiSig;
var _ = opcat.util._;


describe('MultiSigInput', function () {
  var privateKey1 = new PrivateKey('KwF9LjRraetZuEjR8VqEq539z137LW5anYDUnVK11vM3mNMHTWb4');
  var privateKey2 = new PrivateKey('L4PqnaPTCkYhAqH3YQmefjxQP6zRcF4EJbdGqR8v6adtG9XSsadY');
  var privateKey3 = new PrivateKey('L4CTX79zFeksZTyyoFuPQAySfmP7fL3R41gWKTuepuN7hxuNuJwV');
  var public1 = privateKey1.publicKey;
  var public2 = privateKey2.publicKey;
  var public3 = privateKey3.publicKey;
  var output = {
    txId: '66e64ef8a3b384164b78453fa8c8194de9a473ba14f89485a0e433699daec140',
    outputIndex: 0,
    script: new Script(
      '5221025c95ec627038e85b5688a9b3d84d28c5ebe66e8c8d697d498e20fe96e3b1ab1d2102cdddfc974d41a62f1f80081deee70592feb7d6e6cf6739d6592edbe7946720e72103c95924e02c240b5545089c69c6432447412b58be43fd671918bd184a5009834353ae',
    ),
    satoshis: 1000000,
  };
 
  it('can parse list of signature buffers, from TX signed with key 1 and 2', function () {
    var transaction = new Transaction(
      '010000000140c1ae9d6933e4a08594f814ba73a4e94d19c8a83f45784b1684b3a3f84ee666000000009200483045022100e5218e00433c9b1acef6514c9793638f2d39dfb0ee533981de62b7dedf23a6dd022078db45cd64c33b1bf3c971b32b5ecdb778ca71ef1d986b08adbab040b01a987b0147304402204572f05fb95c710118c61ef84b0dcd724f683ac4be0d13ac4464ed3815e1d00002202857d0bc273d7daab16fe7c033073a38aea36e994c3dde6fda569174251bc86b01ffffffff0140420f000000000017a91419438da7d16709643be5abd8df62ca4034a489a7870000000000',
    );

    var inputObj = transaction.inputs[0].toObject();
    inputObj.output = output;
    transaction.inputs[0] = new Transaction.Input(inputObj);

    inputObj.signatures = MultiSigInput.normalizeSignatures(
      transaction,
      transaction.inputs[0],
      0,
      transaction.inputs[0].script.chunks.slice(1).map(function (s) {
        return s.buf;
      }),
      [public1, public2, public3],
    );

    transaction.inputs[0] = new MultiSigInput(inputObj, [public1, public2, public3], 2);

    transaction.inputs[0].signatures[0].publicKey.should.deep.equal(public1);
    transaction.inputs[0].signatures[1].publicKey.should.deep.equal(public2);
    should.equal(transaction.inputs[0].signatures[2], undefined);
    transaction.inputs[0]
      .isValidSignature(transaction, transaction.inputs[0].signatures[0])
      .should.equal(true);
    transaction.inputs[0]
      .isValidSignature(transaction, transaction.inputs[0].signatures[1])
      .should.equal(true);
  });
  it('can parse list of signature buffers, from TX signed with key 3 and 1', function () {
    var transaction = new Transaction(
      '010000000140c1ae9d6933e4a08594f814ba73a4e94d19c8a83f45784b1684b3a3f84ee666000000009100473044022015237aecef3fcc33c8f9e2bda1dc4f3a41d972825509a9186d290f51d845228d022074e8d43f406261fc28cabd37760bb7cc0d46fa66b1e39d74104703c1dc114c790147304402204572f05fb95c710118c61ef84b0dcd724f683ac4be0d13ac4464ed3815e1d00002202857d0bc273d7daab16fe7c033073a38aea36e994c3dde6fda569174251bc86b01ffffffff0140420f000000000017a91419438da7d16709643be5abd8df62ca4034a489a7870000000000',
    );

    var inputObj = transaction.inputs[0].toObject();
    inputObj.output = output;
    transaction.inputs[0] = new Transaction.Input(inputObj);

    inputObj.signatures = MultiSigInput.normalizeSignatures(
      transaction,
      transaction.inputs[0],
      0,
      transaction.inputs[0].script.chunks.slice(1).map(function (s) {
        return s.buf;
      }),
      [public1, public2, public3],
    );

    transaction.inputs[0] = new MultiSigInput(inputObj, [public1, public2, public3], 2);

    transaction.inputs[0].signatures[0].publicKey.should.deep.equal(public1);
    should.equal(transaction.inputs[0].signatures[1], undefined);
    transaction.inputs[0].signatures[2].publicKey.should.deep.equal(public3);
    transaction.inputs[0]
      .isValidSignature(transaction, transaction.inputs[0].signatures[0])
      .should.equal(true);
    transaction.inputs[0]
      .isValidSignature(transaction, transaction.inputs[0].signatures[2])
      .should.equal(true);
  });
});
