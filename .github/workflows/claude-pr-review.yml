name: Claude Code PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    name: Review PR with Claude Code
    timeout-minutes: 10
    continue-on-error: true
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Validate API credentials
        run: |
          if [[ -z "${{ secrets.ANTHROPIC_AUTH_TOKEN }}" ]]; then
            echo "::error::ANTHROPIC_AUTH_TOKEN secret not configured"
            exit 1
          fi
          if [[ -z "${{ secrets.ANTHROPIC_BASE_URL }}" ]]; then
            echo "::error::ANTHROPIC_BASE_URL secret not configured"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          echo "Claude Code CLI installed successfully"

      - name: Verify Claude Code installation
        run: |
          if ! command -v claude &> /dev/null; then
            echo "::error::Claude Code CLI installation failed"
            exit 1
          fi
          echo "Claude Code CLI version:"
          claude --version

      - name: Get PR diff
        id: pr-diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if ! gh pr diff ${{ github.event.pull_request.number }} > pr.diff; then
            echo "::error::Failed to get PR diff"
            exit 1
          fi

          DIFF_LINES=$(wc -l < pr.diff)
          echo "diff-size=$DIFF_LINES" >> $GITHUB_OUTPUT

          # Check diff size and warn about costs
          if [[ $DIFF_LINES -gt 10000 ]]; then
            echo "::error::PR too large for automated review (>10k lines: $DIFF_LINES lines)"
            exit 1
          elif [[ $DIFF_LINES -gt 5000 ]]; then
            echo "::warning::Large PR detected ($DIFF_LINES lines). Estimated cost: \$2-5"
          elif [[ $DIFF_LINES -gt 2000 ]]; then
            echo "::warning::Medium PR detected ($DIFF_LINES lines). Estimated cost: \$0.40-1.00"
          fi

      - name: Review with Claude Code CLI
        id: claude-review
        env:
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail

          # Sanitize inputs
          PR_TITLE_SAFE=$(echo "$PR_TITLE" | head -c 200 | tr -d '\n\r')
          PR_BODY_SAFE=$(echo "$PR_BODY" | head -c 2000 | tr -d '\n\r')

          # Create review prompt file
          echo "You are an expert code reviewer specializing in Bitcoin/cryptocurrency codebases and C++ development. Review the following pull request changes and provide:" > prompt.txt
          echo "" >> prompt.txt
          echo "1. **Summary of Changes**: Brief overview of what this PR accomplishes" >> prompt.txt
          echo "2. **Code Quality Assessment**:" >> prompt.txt
          echo "   - Code style and readability" >> prompt.txt
          echo "   - Best practices adherence" >> prompt.txt
          echo "   - Potential maintainability concerns" >> prompt.txt
          echo "3. **Potential Issues or Bugs**:" >> prompt.txt
          echo "   - Logic errors" >> prompt.txt
          echo "   - Edge cases not handled" >> prompt.txt
          echo "   - Resource leaks or memory issues" >> prompt.txt
          echo "4. **Security Concerns**:" >> prompt.txt
          echo "   - Vulnerability risks" >> prompt.txt
          echo "   - Input validation issues" >> prompt.txt
          echo "   - Consensus-critical changes that need extra scrutiny" >> prompt.txt
          echo "5. **Performance Considerations**:" >> prompt.txt
          echo "   - Inefficient algorithms or data structures" >> prompt.txt
          echo "   - Unnecessary allocations or copies" >> prompt.txt
          echo "   - Threading or concurrency issues" >> prompt.txt
          echo "6. **Testing Recommendations**:" >> prompt.txt
          echo "   - What test cases should be added" >> prompt.txt
          echo "   - Missing test coverage" >> prompt.txt
          echo "7. **Suggestions for Improvement**: Concrete, actionable recommendations" >> prompt.txt
          echo "" >> prompt.txt
          echo "PR Title: $PR_TITLE_SAFE" >> prompt.txt
          echo "PR Description: $PR_BODY_SAFE" >> prompt.txt
          echo "" >> prompt.txt
          echo "Changes:" >> prompt.txt
          echo '```diff' >> prompt.txt
          cat pr.diff >> prompt.txt
          echo '```' >> prompt.txt
          echo "" >> prompt.txt
          echo "Provide a concise, actionable review in markdown format. Focus on the most important issues first." >> prompt.txt

          # Use Claude Code CLI in non-interactive mode
          # Pass the prompt file and capture output
          if ! cat prompt.txt | claude > review.md 2>claude_error.log; then
            echo "::error::Claude Code CLI failed"
            if [[ -f claude_error.log ]]; then
              echo "Error log:"
              cat claude_error.log
            fi
            exit 1
          fi

          # Verify review file was created and is not empty
          if [[ ! -f review.md || ! -s review.md ]]; then
            echo "::error::Review file not created or is empty"
            exit 1
          fi

      - name: Post or update review comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if [[ ! -f review.md ]]; then
            echo "::error::Review file not found"
            exit 1
          fi

          # Add unique identifier and timestamp
          COMMENT_MARKER="<!-- claude-code-review -->"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"

          # Prepare comment body with marker and timestamp
          echo "${COMMENT_MARKER}" > comment.md
          echo "" >> comment.md
          cat review.md >> comment.md
          echo "" >> comment.md
          echo "---" >> comment.md
          echo "**Last updated**: ${TIMESTAMP}" >> comment.md
          echo "**Reviewed commit**: [\`${COMMIT_SHA:0:7}\`](${{ github.event.pull_request.head.repo.html_url }}/commit/${COMMIT_SHA})" >> comment.md

          # Try to find existing comment by github-actions bot with our marker
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "Looking for existing Claude review comment in PR #${PR_NUMBER}..."

          EXISTING_COMMENT_ID=$(gh api \
            "/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("claude-code-review"))) | .id' \
            | head -1)

          if [[ -n "$EXISTING_COMMENT_ID" ]]; then
            echo "Found existing comment ID: $EXISTING_COMMENT_ID"
            echo "Updating existing comment..."

            # Update existing comment
            gh api \
              --method PATCH \
              "/repos/${{ github.repository }}/issues/comments/${EXISTING_COMMENT_ID}" \
              -f body="$(cat comment.md)" \
              > /dev/null

            echo "✅ Comment updated successfully"
            echo "View comment: ${{ github.event.pull_request.html_url }}#issuecomment-${EXISTING_COMMENT_ID}"
          else
            echo "No existing comment found, creating new comment..."

            # Create new comment
            if ! gh pr comment ${PR_NUMBER} --body-file comment.md; then
              echo "::error::Failed to post review comment"
              exit 1
            fi

            echo "✅ New comment created successfully"
          fi