name: Test Publish Beta (Auto)

on:
  push:
    branches:
      - beta-release
    paths:
      - '.github/workflows/**'
      - 'scripts/**'
      - 'docker/**'

jobs:
  construct_version:
    runs-on: ubuntu-latest
    outputs:
      full_version: ${{ steps.version.outputs.full_version }}
      commit_sha: ${{ steps.version.outputs.commit_sha }}
    steps:
      - name: Checkout to get commit SHA
        uses: actions/checkout@v4

      - name: Construct full version
        id: version
        run: |
          COMMIT_SHA="${{ github.sha }}"
          VERSION_CORE="2.0.0"
          SHORT_SHA="${COMMIT_SHA:0:8}"
          COMMIT_DATE=$(date +%Y%m%d)
          FULL_VERSION="${VERSION_CORE}-beta-${SHORT_SHA}-${COMMIT_DATE}"
          echo "full_version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Constructed version: ${FULL_VERSION}"
          echo "ðŸ“Œ Using commit: ${COMMIT_SHA}"

  publish-npm:
    needs: construct_version
    uses: ./.github/workflows/publish-npm.yml
    with:
      commit_sha: ${{ needs.construct_version.outputs.commit_sha }}
      full_version: ${{ needs.construct_version.outputs.full_version }}
      npmTag: beta
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-docker:
    needs: construct_version
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/publish-docker.yml
    with:
      commit: ${{ needs.construct_version.outputs.commit_sha }}
      dockerTag: ${{ needs.construct_version.outputs.full_version }}
